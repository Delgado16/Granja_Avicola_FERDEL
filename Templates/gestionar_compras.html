{% extends 'layout.html' %}

{% block title %}Gestionar Compras{% endblock %}

{% block main %}
<div class="container mt-4" style="max-width: 960px;">
    <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body">
            <h2 class="text-center text-primary fw-bold mb-4">Historial de Compras</h2>

            <!-- Tabla dentro de card desplazable -->
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-striped table-bordered align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Proveedor</th>
                            <th>Factura</th>
                            <th>Tipo de Pago</th>
                            <th>Observaciones</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for compra in compras %}
                        <tr>
                            <td>{{ compra.id }}</td>
                            <td>{{ compra.fecha }}</td>
                            <td>{{ compra.proveedor }}</td>
                            <td>{{ compra.factura }}</td>
                            <td>{{ 'Contado' if compra.tipo_pago == 0 else 'Crédito' }}</td>
                            <td>{{ compra.observacion }}</td>
                            <td>{{ 'C$ ' ~ "{:,.2f}".format(compra.total).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                            <td>
                                <a href="/compras/{{ compra.id }}" class="btn btn-sm btn-info mb-1">Ver</a>
                                <button class="btn btn-sm btn-warning mb-1"
                                        onclick="llenarModalEditar({{ compra | tojson | safe }})"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalEditarCompra">Editar</button>
                                <a href="/compras/{{ compra.id }}/eliminar" class="btn btn-sm btn-danger mb-1"
                                    onclick="return confirm('¿Seguro que deseas eliminar esta compra?');">Eliminar</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="8" class="text-center">No hay compras registradas.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edición de Compra -->
<div class="modal fade" id="modalEditarCompra" tabindex="-1" aria-labelledby="modalEditarCompraLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title">Editar Compra</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form id="formEditarCompra" method="POST">
        <div class="modal-body">
          <input type="hidden" name="id" id="editar_id">
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">Fecha</label>
              <input type="date" class="form-control" name="fecha" id="editar_fecha" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Proveedor</label>
              <select class="form-select" name="proveedor" id="editar_proveedor" required>
                {% for proveedor in proveedores %}
                  <option value="{{ proveedor.id }}">{{ proveedor.Nombre }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Factura</label>
              <input type="text" class="form-control" name="n_factura" id="editar_factura">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">Tipo de Pago</label>
              <select class="form-select" name="tipo_pago" id="editar_tipo_pago">
                <option value="0">Contado</option>
                <option value="1">Crédito</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Empresa</label>
              <select class="form-select" name="id_empresa" id="editar_empresa" required>
                {% for empresa in empresas %}
                  <option value="{{ empresa.ID_Empresa }}">{{ empresa.Descripcion }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Bodega</label>
              <select class="form-select" name="id_bodega" id="editar_bodega" required>
                {% for bodega in bodegas %}
                  <option value="{{ bodega.ID_Bodega }}">{{ bodega.Nombre }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Observación</label>
            <textarea class="form-control" name="observacion" id="editar_observacion" rows="2"></textarea>
          </div>

          <div class="alert alert-warning">
            Los productos de la compra no se pueden editar desde esta ventana.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function llenarModalEditar(compra) {
    document.getElementById('formEditarCompra').action = `/compras/${compra.id}/editar`;
    document.getElementById('editar_id').value = compra.id;
    document.getElementById('editar_fecha').value = compra.fecha;
    document.getElementById('editar_proveedor').value = compra.proveedor_id;
    document.getElementById('editar_factura').value = compra.factura;
    document.getElementById('editar_tipo_pago').value = compra.tipo_pago;
    document.getElementById('editar_observacion').value = compra.observacion;
    document.getElementById('editar_empresa').value = compra.id_empresa;
    document.getElementById('editar_bodega').value = compra.id_bodega;
}
</script>
{% endblock %}
