{% extends "layout.html" %}

{% block title %}Editar Venta{% endblock %}

{% block main %}
<style>
    :root {
        --primary-color: #4361ee;
        --secondary-color: #3f37c9;
        --success-color: #4cc9f0;
        --danger-color: #f72585;
        --card-max-width: 1200px;
        --card-padding: 1.5rem;
    }

    .venta-container {
        max-width: var(--card-max-width);
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .card-venta {
        border: none;
        border-radius: 0.75rem;
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1);
    }

    .card-header-venta {
        background-color: var(--primary-color);
        color: white;
        border-radius: 0.75rem 0.75rem 0 0;
        padding: 1.25rem 2rem;
    }

    .card-title-venta {
        font-size: 1.75rem;
        font-weight: 600;
        margin: 0;
    }

    .card-body-venta {
        padding: 2rem;
    }

    .form-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }

    .section-title {
        font-size: 1.25rem;
        color: var(--secondary-color);
        font-weight: 500;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .product-table {
        width: 100%;
        margin-bottom: 1.5rem;
        border-collapse: separate;
        border-spacing: 0;
    }

    .product-table th {
        background-color: #e9ecef;
        font-weight: 600;
        white-space: nowrap;
        padding: 1rem;
        border-top: 1px solid #dee2e6;
    }

    .product-table td {
        padding: 1rem;
        vertical-align: middle;
        border-top: 1px solid #dee2e6;
    }

    .product-table tbody tr:first-child td {
        border-top: none;
    }

    .product-table .form-control {
        min-width: 100px;
    }

    .total-summary {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }

    .grand-total {
        border-top: 2px solid #dee2e6;
        padding-top: 1rem;
        margin-top: 1rem;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .btn-add-product {
        margin-bottom: 1.5rem;
        background-color: var(--success-color);
        border-color: var(--success-color);
    }

    .btn-cancel {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .btn-save {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    /* Responsive styles */
    @media (max-width: 992px) {
        .card-body-venta {
            padding: 1.5rem;
        }
    }

    @media (max-width: 768px) {
        .venta-container {
            padding: 0 0.5rem;
        }
        
        .card-body-venta {
            padding: 1rem;
        }
        
        .product-table th,
        .product-table td {
            padding: 0.75rem;
        }
    }

    @media (max-width: 576px) {
        /* Mobile table styles */
        .product-table {
            display: block;
            width: 100%;
        }
        
        .product-table thead {
            display: none;
        }
        
        .product-table tbody, 
        .product-table tr, 
        .product-table td {
            display: block;
            width: 100%;
        }
        
        .product-table tr {
            margin-bottom: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            position: relative;
            padding-top: 3rem;
        }
        
        .product-table td {
            padding: 0.75rem;
            padding-left: 50%;
            border: none;
        }
        
        .product-table td::before {
            content: attr(data-label);
            position: absolute;
            left: 1rem;
            width: 45%;
            font-weight: 600;
            color: #495057;
        }
        
        .product-table td:last-child {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: auto;
            padding: 0;
            text-align: right;
        }
        
        .product-table td:last-child::before {
            display: none;
        }
        
        .product-table select,
        .product-table input {
            width: 100%;
        }
    }
</style>

<div class="container-fluid venta-container">
    <div class="card card-venta">
        <div class="card-header card-header-venta">
            <h1 class="card-title card-title-venta">Editar Venta #{{ venta.ID_Factura }}</h1>
        </div>
        
        <div class="card-body card-body-venta">
            <form id="form-editar-venta" method="post" action="{{ url_for('editar_venta', venta_id=venta.ID_Factura) }}">
                <!-- Información básica -->
                <div class="form-section">
                    <h3 class="section-title">Información de la Venta</h3>
                    
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="n_factura" class="form-label">N° Factura</label>
                            <input type="text" class="form-control" id="n_factura" value="{{ n_factura }}" readonly>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="fecha" class="form-label">Fecha*</label>
                            <input type="date" class="form-control" id="fecha" name="fecha" value="{{ venta.Fecha }}" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="cliente" class="form-label">Cliente*</label>
                            <select class="form-select" id="cliente" name="cliente" required>
                                <option value="">Seleccione un cliente</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}" {% if cliente.id == venta.IDCliente %}selected{% endif %}>{{ cliente.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="tipo_pago" class="form-label">Tipo de Pago*</label>
                            <select class="form-select" id="tipo_pago" name="tipo_pago" required>
                                <option value="0" {% if venta.Credito_Contado == 0 %}selected{% endif %}>Contado</option>
                                <option value="1" {% if venta.Credito_Contado == 1 %}selected{% endif %}>Crédito</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="id_bodega" class="form-label">Bodega*</label>
                            <select class="form-select" id="id_bodega" name="id_bodega" required>
                                <option value="">Seleccione una bodega</option>
                                {% for bodega in bodegas %}
                                <option value="{{ bodega.id }}" {% if bodega.id == venta.ID_Bodega %}selected{% endif %}>{{ bodega.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="estado" class="form-label">Estado</label>
                            <select class="form-select" id="estado" name="estado">
                                <option value="1" {% if venta.Estado == 1 %}selected{% endif %}>Activa</option>
                                <option value="0" {% if venta.Estado == 0 %}selected{% endif %}>Anulada</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label for="observacion" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observacion" name="observacion" rows="2">{{ venta.Observacion }}</textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Productos -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="section-title">Productos</h3>
                        <button type="button" class="btn btn-primary btn-add-product" id="agregar-producto">
                            <i class="bi bi-plus-circle"></i> Agregar Producto
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table product-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>IVA</th>
                                    <th>Descuento</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="productos-container">
                                {% for detalle in detalles %}
                                <tr class="producto-row">
                                    <td data-label="Producto">
                                        <select class="form-select producto-select" name="productos[]" required>
                                            <option value="">Seleccione</option>
                                            {% for producto in productos %}
                                            <option value="{{ producto.id }}" 
                                                    data-precio="{{ producto.precio|default(0) }}" 
                                                    {% if producto.id == detalle.ID_Producto %}selected{% endif %}>
                                                {{ producto.descripcion }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <input type="hidden" name="detalles_ids[]" value="{{ detalle.ID_Detalle }}">
                                    </td>
                                    <td data-label="Cantidad">
                                        <input type="number" class="form-control cantidad" name="cantidades[]" 
                                               min="1" step="0.01" value="{{ detalle.Cantidad }}" required>
                                    </td>
                                    <td data-label="Precio Unitario">
                                        <input type="number" class="form-control precio" name="precios[]" 
                                               min="0" step="0.01" value="{{ detalle.Precio }}" required>
                                    </td>
                                    <td data-label="IVA">
                                        <input type="number" class="form-control iva" name="ivas[]" 
                                               min="0" step="0.01" value="{{ detalle.IVA }}" required>
                                    </td>
                                    <td data-label="Descuento">
                                        <input type="number" class="form-control descuento" name="descuentos[]" 
                                               min="0" step="0.01" value="{{ detalle.Descuento }}" required>
                                    </td>
                                    <td data-label="Total">
                                        <input type="text" class="form-control total" readonly>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm eliminar-producto">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Resumen de totales -->
                    <div class="total-summary">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">C$0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Descuentos:</span>
                            <span id="total-descuentos">C$0.00</span>
                        </div>
                        <div class="total-row">
                            <span>IVA:</span>
                            <span id="total-iva">C$0.00</span>
                        </div>
                        <div class="total-row grand-total">
                            <span>Total Venta:</span>
                            <span id="total-venta">C$0.00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Botones de acción -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{{ url_for('gestionar_ventas') }}" class="btn btn-secondary btn-cancel">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary btn-save">
                        <i class="bi bi-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Plantilla para nueva fila de producto
    const nuevaFilaProducto = `
    <tr class="producto-row">
        <td data-label="Producto">
            <select class="form-select producto-select" name="productos[]" required>
                <option value="">Seleccione</option>
                {% for producto in productos %}
                <option value="{{ producto.id }}" data-precio="{{ producto.precio|default(0) }}">{{ producto.descripcion }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="detalles_ids[]" value="0">
        </td>
        <td data-label="Cantidad">
            <input type="number" class="form-control cantidad" name="cantidades[]" min="1" step="0.01" required>
        </td>
        <td data-label="Precio Unitario">
            <input type="number" class="form-control precio" name="precios[]" min="0" step="0.01" required>
        </td>
        <td data-label="IVA">
            <input type="number" class="form-control iva" name="ivas[]" min="0" step="0.01" required>
        </td>
        <td data-label="Descuento">
            <input type="number" class="form-control descuento" name="descuentos[]" min="0" step="0.01" required>
        </td>
        <td data-label="Total">
            <input type="text" class="form-control total" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm eliminar-producto">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </tr>`;
    
    // Agregar nueva fila de producto
    document.getElementById('agregar-producto').addEventListener('click', function() {
        const container = document.getElementById('productos-container');
        container.insertAdjacentHTML('beforeend', nuevaFilaProducto);
        
        // Configurar data-labels para móviles
        const nuevaFila = container.lastElementChild;
        const celdas = nuevaFila.querySelectorAll('td');
        const etiquetas = ["Producto", "Cantidad", "Precio Unitario", "IVA", "Descuento", "Total"];
        
        celdas.forEach((celda, index) => {
            if (index < etiquetas.length) {
                celda.setAttribute('data-label', etiquetas[index]);
            }
        });
        
        // Desplazarse a la nueva fila en móviles
        if (window.innerWidth <= 576) {
            nuevaFila.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    });
    
    // Eliminar fila de producto
    document.addEventListener('click', function(e) {
        if (e.target.closest('.eliminar-producto')) {
            const fila = e.target.closest('tr');
            if (document.querySelectorAll('.producto-row').length > 1) {
                fila.remove();
                calcularTotales();
            } else {
                mostrarAlerta('warning', 'Advertencia', 'Debe haber al menos un producto en la venta');
            }
        }
    });
    
    // Calcular total cuando cambian los valores
    document.addEventListener('input', function(e) {
        if (e.target.matches('.cantidad, .precio, .iva, .descuento')) {
            const fila = e.target.closest('tr');
            calcularSubtotal(fila);
            calcularTotales();
        }
    });
    
    // Autocompletar precio al seleccionar producto
    document.addEventListener('change', function(e) {
        if (e.target.matches('.producto-select')) {
            const precio = e.target.selectedOptions[0].dataset.precio;
            if (precio) {
                e.target.closest('tr').querySelector('.precio').value = precio;
                calcularSubtotal(e.target.closest('tr'));
                calcularTotales();
            }
        }
    });
    
    // Calcular subtotal por fila
    function calcularSubtotal(fila) {
        const cantidad = parseFloat(fila.querySelector('.cantidad').value) || 0;
        const precio = parseFloat(fila.querySelector('.precio').value) || 0;
        const iva = parseFloat(fila.querySelector('.iva').value) || 0;
        const descuento = parseFloat(fila.querySelector('.descuento').value) || 0;
        
        const subtotal = cantidad * precio;
        const total = subtotal + iva - descuento;
        
        fila.querySelector('.total').value = total.toFixed(2);
    }
    
    // Calcular totales generales
    function calcularTotales() {
        let subtotal = 0;
        let totalIva = 0;
        let totalDescuentos = 0;
        let totalVenta = 0;
        
        document.querySelectorAll('.producto-row').forEach(fila => {
            const cantidad = parseFloat(fila.querySelector('.cantidad').value) || 0;
            const precio = parseFloat(fila.querySelector('.precio').value) || 0;
            const iva = parseFloat(fila.querySelector('.iva').value) || 0;
            const descuento = parseFloat(fila.querySelector('.descuento').value) || 0;
            
            subtotal += cantidad * precio;
            totalIva += iva;
            totalDescuentos += descuento;
            totalVenta += (cantidad * precio) + iva - descuento;
        });
        
        document.getElementById('subtotal').textContent = `C$${subtotal.toFixed(2)}`;
        document.getElementById('total-iva').textContent = `C$${totalIva.toFixed(2)}`;
        document.getElementById('total-descuentos').textContent = `C$${totalDescuentos.toFixed(2)}`;
        document.getElementById('total-venta').textContent = `C$${totalVenta.toFixed(2)}`;
    }
    
    // Mostrar alerta
    function mostrarAlerta(tipo, titulo, mensaje) {
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed end-0 m-3`;
        alerta.style.zIndex = '1100';
        alerta.innerHTML = `
            <strong>${titulo}</strong> ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alerta);
        
        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.remove();
            }
        }, 4000);
    }
    
    // Validar formulario antes de enviar
    document.getElementById('form-editar-venta').addEventListener('submit', function(e) {
        let valido = true;
        
        // Validar campos principales
        const camposRequeridos = this.querySelectorAll('[required]');
        camposRequeridos.forEach(campo => {
            if (!campo.value) {
                campo.classList.add('is-invalid');
                valido = false;
            } else {
                campo.classList.remove('is-invalid');
            }
        });
        
        // Validar al menos un producto
        if (document.querySelectorAll('.producto-row').length === 0) {
            mostrarAlerta('danger', 'Error', 'Debe agregar al menos un producto');
            valido = false;
        }
        
        if (!valido) {
            e.preventDefault();
            mostrarAlerta('danger', 'Error', 'Por favor complete todos los campos requeridos');
            document.querySelector('.is-invalid')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
    
    // Calcular totales iniciales
    document.querySelectorAll('.producto-row').forEach(fila => {
        calcularSubtotal(fila);
    });
    calcularTotales();
    
    // Configurar data-labels para móviles en filas existentes
    document.querySelectorAll('.producto-row').forEach(fila => {
        const celdas = fila.querySelectorAll('td');
        const etiquetas = ["Producto", "Cantidad", "Precio Unitario", "IVA", "Descuento", "Total"];
        
        celdas.forEach((celda, index) => {
            if (index < etiquetas.length) {
                celda.setAttribute('data-label', etiquetas[index]);
            }
        });
    });
});
</script>
{% endblock %}